<template id="template-zombie-game">
  <style>
    #arena { 
      position: relative; 
      height: clamp(180px, 36vh, 320px); 
      margin-top: 10px; 
      background: linear-gradient(#f0f9ff, #e0f2fe); 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: inset 0 -6px 0 #cbd5e1; 
    }
    #hero, #zombie, #projectile { 
      position: absolute; 
      bottom: 0; 
      height: clamp(90px, 26vh, 200px); 
      max-width: 32vw; 
      object-fit: contain; 
      user-select: none; 
      pointer-events: none; 
    }
    #hero { left: min(3vw, 24px); }
    #zombie { right: min(3vw, 24px); transition: right 0.08s linear; }
    #projectile { 
      width: clamp(18px, 3vh, 28px); 
      height: clamp(18px, 3vh, 28px); 
      background: radial-gradient(circle, #38bdf8 0%, #0284c7 80%); 
      border-radius: 50%; 
      display: none; 
      bottom: calc(clamp(90px, 26vh, 200px) * 0.55); 
      z-index: 10; 
    }
    
    .question-zone { 
      margin-bottom: 10px; 
      font-size: 1.3em; 
      text-align: center; 
      min-height: 2em; 
      color: #334155; 
      font-weight: 600; 
      margin-top: 15px; 
    }

    #ai-input-zone { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 10px; 
      width: 100%; 
      max-width: 600px; 
      margin: 0 auto; 
      position: relative; 
    }
    
    textarea#answer {
      width: 100%; 
      padding: 12px; 
      font-size: 16px; 
      border-radius: 10px;
      border: 2px solid #cbd5e1; 
      resize: none; 
      height: 80px; 
      font-family: inherit;
    }
    textarea#answer:focus { border-color: #3b82f6; outline: none; }
    
    .buttons-row { display: flex; gap: 10px; width: 100%; justify-content: center; }
    button { 
      padding: 10px 20px; 
      border: 0; 
      border-radius: 8px; 
      font-size: 15px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: 0.2s; 
    }
    #submit { background: #2563eb; color: #fff; flex: 1; }
    #submit:disabled { background: #94a3b8; cursor: not-allowed; }
    
    /* BADGE BRAVO (Vert) */
    #bravo-badge {
      position: absolute; 
      top: 10px; right: 10px; 
      background: #ffffff; color: #1e293b;
      padding: 12px 16px; border-radius: 12px; 
      font-weight: bold; font-size: 14px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
      display: none; animation: popIn 0.3s ease-out;
      z-index: 50; max-width: 320px; text-align: left; 
      border: 2px solid #22c55e;
    }
    
    .spelling-list { 
      margin: 8px 0 0; padding: 0; list-style: none; 
      font-size: 0.9em; background: #f0fdf4; 
      padding: 8px; border-radius: 8px; border: 1px solid #bbf7d0;
    }
    .spelling-item { display: block; margin-bottom: 4px; }
    .wrong-word { color: #ef4444; text-decoration: line-through; margin-right: 6px; opacity: 0.7; }
    .right-word { color: #15803d; font-weight: 800; text-transform: uppercase; }
    
    /* FEEDBACK IA (Sous la zone de texte) */
    #analysis-msg { 
      display: none; 
      margin-top: 5px; 
      padding: 10px; 
      border-radius: 8px; 
      font-size: 14px; 
      width: 100%;
      text-align: center;
      line-height: 1.4;
    }
    .msg-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .msg-info { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
    .msg-hint { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; font-weight: bold; }

    @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
  
  <div id="arena"> 
    <img id="hero" src="images/hero.png" alt="HÃ©ros" /> 
    <img id="zombie" src="images/zombi.png" alt="Zombie" /> 
    <div id="projectile"></div> 
    <div id="bravo-badge"></div>
  </div>

  <div id="question" class="question-zone"></div>
  
  <div id="ai-input-zone">
    <textarea id="answer" placeholder="Ã‰cris ta rÃ©ponse..." autocomplete="off"></textarea>
    <div class="buttons-row">
      <button id="submit">Envoyer Ã  l'IA ðŸ¤–</button>
    </div>
    <div id="analysis-msg"></div>
  </div>
</template>

<script>
class ZombieGame {
  constructor(c, ctrl) {
    this.c = c; this.ctrl = ctrl;
    this.hero = c.querySelector("#hero"); 
    this.zombie = c.querySelector("#zombie");
    this.projectile = c.querySelector("#projectile"); 
    this.arena = c.querySelector("#arena");
    this.qEl = c.querySelector("#question");
    
    this.input = c.querySelector("#answer");
    this.subBtn = c.querySelector("#submit");
    this.bravoBadge = c.querySelector("#bravo-badge");
    this.analysisMsg = c.querySelector("#analysis-msg");

    this.zInt = null; this.pInt = null; 
    this.zPos = 20; 
    this.zPaused = false; 
    this.resetting = false;
    
    this.subBtn.onclick = () => this.askAI();
    this.input.onkeydown = (e) => { 
        // EntrÃ©e valide, sauf si Shift (pour retour ligne)
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.askAI(); } 
    };
    this.input.addEventListener("input", () => { 
        // Pause auto quand on tape
        this.zPaused = (this.input.value.length > 0); 
    });
  }

  loadQuestion(q) {
    this.resetting = false; 
    this.qEl.textContent = q.q; 
    this.input.value = ""; 
    this.input.disabled = false;
    this.subBtn.disabled = false; 
    this.subBtn.textContent = "Envoyer Ã  l'IA ðŸ¤–";
    this.bravoBadge.style.display = "none"; 
    this.analysisMsg.style.display = "none";
    
    // RESET
    this.zPos = 20; 
    this.zombie.style.right = "20px"; 
    this.zombie.style.display = "block"; 
    this.zombie.style.opacity = "1";
    this.zPaused = false; 
    
    setTimeout(() => this.input.focus(), 100);
  }

  async askAI() {
    if(this.ctrl.getState().isLocked || this.input.value.trim() === "") return;
    
    // UI Chargement
    this.zPaused = true; 
    this.input.disabled = true; 
    this.subBtn.disabled = true;
    this.analysisMsg.className = "msg-info";
    this.analysisMsg.textContent = "ðŸ§  L'IA analyse ta rÃ©ponse..."; 
    this.analysisMsg.style.display = "block";

    const currentQ = (typeof levels !== 'undefined') ? levels[currentLevel].questions[currentIndex] : null;
    if(!currentQ) return;

    try {
      const res = await fetch('/api/verify-answer-ai', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            question: currentQ.q, 
            userAnswer: this.input.value, 
            expectedAnswer: currentQ.a 
        })
      });
      const data = await res.json();
      this.handleResponse(data);
    } catch (err) { 
      console.error(err); 
      this.input.disabled = false; 
      this.subBtn.disabled = false; 
      this.analysisMsg.className = "msg-error";
      this.analysisMsg.textContent = "Erreur connexion IA.";
    }
  }

  handleResponse(data) {
    this.analysisMsg.style.display = "none"; 

    // 1. SUCCÃˆS
    if (data.status === "correct") {
      let html = `<div style="color:#166534">ðŸŽ‰ ${data.feedback || "Bravo !"}</div>`;
      
      if (data.corrections && data.corrections.length > 0) {
        html += `<ul class="spelling-list">`;
        data.corrections.forEach(c => {
            html += `<li class="spelling-item">
                        <span class="wrong-word">${c.wrong}</span> 
                        â†’ <span class="right-word">${c.correct}</span>
                     </li>`;
        });
        html += `</ul>`;
      }

      this.bravoBadge.innerHTML = html;
      this.bravoBadge.style.display = "block"; 
      
      this.win(); // Tire le projectile

      setTimeout(() => { 
          this.ctrl.notifyCorrectAnswer(); 
      }, 4000);
    } 
    // 2. C'EST PROCHE (INDICE)
    else if (data.status === "close") {
      this.analysisMsg.className = "msg-hint";
      this.analysisMsg.innerHTML = `ðŸ’¡ <strong>Indice :</strong> ${data.feedback}`;
      this.analysisMsg.style.display = "block";
      
      // On ne pÃ©nalise PAS, on ne redÃ©marre PAS le zombie.
      // On rend juste la main Ã  l'Ã©lÃ¨ve pour qu'il corrige.
      this.input.disabled = false;
      this.subBtn.disabled = false;
      this.subBtn.textContent = "RÃ©essayer";
      this.input.focus();
      this.zPaused = true; // On garde la pause pour qu'il lise
    }
    // 3. C'EST FAUX
    else {
      this.analysisMsg.className = "msg-error";
      this.analysisMsg.innerHTML = `âŒ ${data.feedback || "Incorrect."}`;
      this.analysisMsg.style.display = "block";
      
      if(typeof localScores !== 'undefined') {
          localScores[currentIndex] = Math.max(0, localScores[currentIndex] - 1);
          if(typeof updateBars === 'function') updateBars();
      }

      setTimeout(() => {
          this.zPaused = false; // Le zombie repart !
          this.input.disabled = false;
          this.subBtn.disabled = false;
          this.subBtn.textContent = "RÃ©essayer";
          this.input.focus();
      }, 2500);
    }
  }

  startAnimation(){ this.moveZ(); } 
  resetAnimation(){ this.stop(); }
  
  moveZ() {
    if(this.zInt) return;
    this.zombie.style.display="block"; 
    this.zombie.style.opacity="1";
    
    const max = this.arena.offsetWidth - this.zombie.offsetWidth - this.hero.offsetWidth - 30;
    const step = max / 50000; 
    
    this.zInt = setInterval(() => {
      if(this.resetting || this.ctrl.getState().isLocked || this.zPaused) return;
      
      this.zPos += step * 20; 
      this.zombie.style.right = this.zPos + "px";
      
      if(this.zPos >= max) { 
          this.ctrl.notifyWrongAnswer(null); 
      }
    }, 20);
  }

  stop() {
    this.resetting = true;
    if(this.zInt) { clearInterval(this.zInt); this.zInt = null; }
    if(this.pInt) { clearInterval(this.pInt); this.pInt = null; }
    this.zPos = 20; 
    this.zPaused = false;
    
    if(this.zombie) { 
        this.zombie.style.right = "20px"; 
        this.zombie.style.display = "block"; 
        this.zombie.style.opacity = "1"; 
    }
    if(this.projectile) { 
        this.projectile.style.display = "none"; 
        this.projectile.style.left = "0px"; 
    }
    
    if(this.input) { this.input.disabled = false; this.input.value = ""; }
    if(this.subBtn) { this.subBtn.disabled = false; this.subBtn.textContent = "Envoyer Ã  l'IA ðŸ¤–"; }
    if(this.bravoBadge) this.bravoBadge.style.display = "none"; 
    if(this.analysisMsg) this.analysisMsg.style.display = "none";
  }

  win() { this.shoot(); }

  shoot() {
    if(this.pInt) return;
    this.projectile.style.display = "block";
    let p = this.hero.offsetWidth;
    const zRight = parseFloat(this.zombie.style.right) || 20;
    const hit = this.arena.offsetWidth - zRight - (this.zombie.offsetWidth / 2);
    
    this.pInt = setInterval(() => {
      if(this.resetting) { clearInterval(this.pInt); this.pInt = null; return; }
      
      p += 25; 
      this.projectile.style.left = p + "px";
      
      if(p >= hit) {
        clearInterval(this.pInt); 
        this.pInt = null;
        this.projectile.style.display = "none"; 
        this.projectile.style.left = "0px";
        if(!this.resetting) this.zombie.style.display = "none";
      }
    }, 20);
  }
}
window.ZombieGame = ZombieGame;
</script>