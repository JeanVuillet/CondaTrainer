<template id="template-starship-game">
  <style>
    /* Le décor du jeu */
    #starship-game-area {
      position: relative;
      height: 450px;
      background: #0c0a18;
      border-radius: 12px;
      overflow: hidden;
      cursor: crosshair;
    }
    /* Le vaisseau du joueur */
    #ship {
      position: absolute;
      bottom: 10px;
      left: 50%;
      width: 60px;
      height: 60px;
      transform: translateX(-50%);
      background: url('/images/ship.png') center/contain no-repeat;
      transition: left 0.1s linear;
    }
    /* Les réponses qui tombent */
    .falling-answer {
      position: absolute;
      top: -80px;
      padding: 10px 20px;
      background: #333;
      color: white;
      border: 2px solid #00f2ff;
      border-radius: 8px;
      font-weight: bold;

      /* ========================================================== */
      /* --- CORRECTION APPLIQUÉE ICI --- */
      /* On passe de 8s à 20s pour ralentir la chute. */
      animation: fall 20s linear forwards;
      /* ========================================================== */
    }
    @keyframes fall {
      from { top: -80px; }
      to { top: 100%; }
    }
    /* Les missiles tirés par le vaisseau */
    .missile {
      position: absolute;
      width: 8px;
      height: 25px;
      background-color: #ffeb3b;
      border-radius: 4px;
      box-shadow: 0 0 10px #ffeb3b;
    }
    .question-zone { margin-bottom: 20px; font-size: 1.5em; text-align: center; min-height: 2.5em; }
  </style>
  
  <div id="question" class="question-zone"></div>
  <div id="starship-game-area">
    <div id="ship"></div>
  </div>
  
  <div id="choices" style="display:none;"></div>
  <div id="freeInputZone" style="display:none;"></div>
</template>

<script>
class StarshipGame {
  constructor(container, controller) {
    this.container = container;
    this.controller = controller;
    this.gameArea = container.querySelector("#starship-game-area");
    this.ship = container.querySelector("#ship");
    this.questionElement = container.querySelector("#question");
    this.missiles = [];
    this.answers = [];
    this.currentQuestion = null;
    this.animationFrameId = null;
    this.bindControls();
  }

  loadQuestion(q) {
    this.currentQuestion = q;
    this.questionElement.textContent = q.q;
    this.clearObjects();
    this.spawnAnswers();
  }

  bindControls() {
    document.addEventListener("keydown", (e) => {
      if (this.controller.getState().isLocked) return;
      if (e.key === "ArrowLeft") this.moveShip(-40);
      if (e.key === "ArrowRight") this.moveShip(40);
      if (e.code === "Space") {
        e.preventDefault();
        this.shoot();
      }
    });
  }

  moveShip(dx) {
    const x = this.ship.offsetLeft + dx;
    const maxX = this.gameArea.offsetWidth - this.ship.offsetWidth;
    this.ship.style.left = Math.max(0, Math.min(maxX, x)) + "px";
  }

  shoot() {
    if (this.missiles.length > 3) return;
    const missile = document.createElement("div");
    missile.className = "missile";
    missile.style.left = this.ship.offsetLeft + this.ship.offsetWidth / 2 - 4 + "px";
    missile.style.bottom = "70px";
    this.gameArea.appendChild(missile);
    this.missiles.push(missile);
  }

  spawnAnswers() {
    let positions = [10, 25, 40, 55, 70, 85].sort(() => 0.5 - Math.random());
    this.currentQuestion.options.forEach((txt, index) => {
      const answerDiv = document.createElement("div");
      answerDiv.className = "falling-answer";
      answerDiv.style.left = `${positions[index]}%`;
      answerDiv.style.animationDelay = `${Math.random() * 2}s`;
      answerDiv.textContent = txt;
      this.gameArea.appendChild(answerDiv);
      this.answers.push(answerDiv);
    });
  }
  
  gameLoop() {
    this.updateMissiles();
    this.checkCollisions();
    this.animationFrameId = requestAnimationFrame(() => this.gameLoop());
  }

  updateMissiles() {
    for (let i = this.missiles.length - 1; i >= 0; i--) {
      const missile = this.missiles[i];
      let currentBottom = parseFloat(missile.style.bottom);
      missile.style.bottom = currentBottom + 10 + "px";
      if (currentBottom > this.gameArea.offsetHeight) {
        missile.remove();
        this.missiles.splice(i, 1);
      }
    }
  }

  checkCollisions() {
    for (let i = this.missiles.length - 1; i >= 0; i--) {
      for (let j = this.answers.length - 1; j >= 0; j--) {
        const missile = this.missiles[i];
        const answer = this.answers[j];
        if (this.isColliding(missile, answer)) {
          this.resetAnimation();
          const isCorrect = answer.textContent === this.currentQuestion.a;
          if (isCorrect) {
            this.controller.notifyCorrectAnswer();
          } else {
            localScores[currentIndex] = Math.max(0, localScores[currentIndex] - 1);
            updateBars();
            this.controller.notifyWrongAnswer(this.currentQuestion);
          }
          return;
        }
      }
    }
  }

  isColliding(a, b) {
    const rectA = a.getBoundingClientRect();
    const rectB = b.getBoundingClientRect();
    return !(rectA.right < rectB.left || rectA.left > rectB.right || rectA.bottom < rectB.top || rectA.top > rectB.bottom);
  }

  clearObjects() {
    this.answers.forEach(a => a.remove());
    this.missiles.forEach(m => m.remove());
    this.answers = [];
    this.missiles = [];
  }
  
  startAnimation() { this.gameLoop(); }
  resetAnimation() {
    cancelAnimationFrame(this.animationFrameId);
    this.clearObjects();
  }
}

window.StarshipGame = StarshipGame;
</script>