<template id="template-starship-game">
  <style>
    /* Zone de question */
    .question-zone { 
      margin: 0 0 10px 0;
      font-size: 1.3em; 
      text-align: center; 
      min-height: 3em;
      color: #111827; 
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.3;
    }
    
    #starship-game-area {
      position: relative;
      /* Hauteur ajust√©e pour bien prendre la place */
      height: clamp(350px, 60vh, 600px); 
      background: radial-gradient(circle at bottom, #1e1b4b, #0f172a);
      border-radius: 12px;
      overflow: hidden;
      border: 4px solid #334155;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }
    
    #ship {
      position: absolute;
      bottom: 60px; /* On remonte un peu le vaisseau pour qu'il ne soit pas cach√© par les boutons au d√©part */
      left: 50%;
      width: 60px;
      height: 60px;
      transform: translateX(-50%);
      background: url('/images/ship.png') center/contain no-repeat;
      z-index: 5; /* Le vaisseau est DERRI√àRE les boutons (z-index 20) */
    }

    .falling-answer {
      position: absolute;
      top: 0px; 
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.95); 
      color: #38bdf8; 
      border: 2px solid #38bdf8;
      border-radius: 8px;
      font-weight: bold;
      font-size: 13px;
      transform: translateX(-50%);
      white-space: normal; 
      text-align: center;
      max-width: 140px;
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
      z-index: 4;
    }

    .missile {
      position: absolute;
      width: 6px;
      height: 20px;
      background-color: #fbbf24;
      border-radius: 4px;
      box-shadow: 0 0 8px #fbbf24;
      z-index: 2;
    }

    /* --- CONTROLES MOBILES (SUPERPOS√âS) --- */
    #mobile-controls {
      position: absolute; /* Superposition */
      bottom: 15px;       /* Coll√© en bas */
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      user-select: none;
      z-index: 20; /* Au-dessus de tout */
      pointer-events: none; /* Permet de cliquer √† travers la zone vide */
    }

    .d-pad {
      display: flex;
      gap: 15px;
      pointer-events: auto; /* R√©active le clic sur les boutons */
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.2); /* Semi-transparent */
      backdrop-filter: blur(4px);
      color: white;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      touch-action: manipulation;
      transition: transform 0.1s, background 0.1s;
    }

    .control-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.4);
    }

    #btn-fire {
      pointer-events: auto;
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.3);
      color: #fbbf24;
      width: 70px;
      height: 70px;
      font-size: 30px;
      box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
    }
    
    #btn-fire:active {
      background: rgba(251, 191, 36, 0.6);
      color: white;
    }

  </style>
  
  <div id="question" class="question-zone"></div>
  
  <div id="starship-game-area">
    <div id="ship"></div>
    
    <!-- ZONE DE CONTR√îLES INT√âGR√âE AU JEU -->
    <div id="mobile-controls">
      <div class="d-pad">
        <div id="btn-left" class="control-btn">‚¨ÖÔ∏è</div>
        <div id="btn-right" class="control-btn">‚û°Ô∏è</div>
      </div>
      <div id="btn-fire" class="control-btn">üî•</div>
    </div>
  </div>
</template>

<script>
class StarshipGame {
  constructor(container, controller) {
    this.container = container;
    this.controller = controller;

    this.gameArea = container.querySelector("#starship-game-area");
    this.ship = container.querySelector("#ship");
    this.questionElement = container.querySelector("#question");

    // Boutons mobiles
    this.btnLeft = container.querySelector("#btn-left");
    this.btnRight = container.querySelector("#btn-right");
    this.btnFire = container.querySelector("#btn-fire");

    this.missiles = [];
    this.answers = [];
    this.currentQuestion = null;
    this.animationFrameId = null;
    
    // √âtat des touches
    this.isLeftPressed = false;
    this.isRightPressed = false;

    // REGLAGES
    this.FALL_DURATION = 24000; 
    this.READING_TIME = 3000;

    this.bindControls();
  }

  loadQuestion(question) {
    this.currentQuestion = question;
    this.questionElement.textContent = question.q;
    this.clearObjects();
    this.spawnAnswers();
    
    if (!this.animationFrameId) {
        this.gameLoop();
    }
  }

  bindControls() {
    // 1. CLAVIER
    this._keydownHandler = (e) => {
      if (this.controller.getState().isLocked) return;
      if (e.key === "ArrowLeft") this.isLeftPressed = true;
      if (e.key === "ArrowRight") this.isRightPressed = true;
      if (e.code === "Space") {
        e.preventDefault();
        this.shoot();
      }
    };
    
    this._keyupHandler = (e) => {
      if (e.key === "ArrowLeft") this.isLeftPressed = false;
      if (e.key === "ArrowRight") this.isRightPressed = false;
    };

    document.addEventListener("keydown", this._keydownHandler);
    document.addEventListener("keyup", this._keyupHandler);

    // 2. TACTILE / SOURIS
    
    // GAUCHE
    const startLeft = (e) => { e.preventDefault(); this.isLeftPressed = true; };
    const endLeft = (e) => { e.preventDefault(); this.isLeftPressed = false; };
    this.btnLeft.addEventListener("mousedown", startLeft);
    this.btnLeft.addEventListener("touchstart", startLeft);
    this.btnLeft.addEventListener("mouseup", endLeft);
    this.btnLeft.addEventListener("touchend", endLeft);
    this.btnLeft.addEventListener("mouseleave", endLeft);

    // DROITE
    const startRight = (e) => { e.preventDefault(); this.isRightPressed = true; };
    const endRight = (e) => { e.preventDefault(); this.isRightPressed = false; };
    this.btnRight.addEventListener("mousedown", startRight);
    this.btnRight.addEventListener("touchstart", startRight);
    this.btnRight.addEventListener("mouseup", endRight);
    this.btnRight.addEventListener("touchend", endRight);
    this.btnRight.addEventListener("mouseleave", endRight);

    // TIR
    const doFire = (e) => { 
        e.preventDefault(); 
        if (!this.controller.getState().isLocked) this.shoot(); 
    };
    this.btnFire.addEventListener("mousedown", doFire);
    this.btnFire.addEventListener("touchstart", doFire);
  }

  moveShip(delta) {
    const newLeft = this.ship.offsetLeft + delta;
    const maxLeft = this.gameArea.offsetWidth - this.ship.offsetWidth; 
    const safeLeft = Math.max(0, Math.min(maxLeft, newLeft));
    this.ship.style.left = safeLeft + "px";
  }

  shoot() {
    if (this.missiles.length > 5) return;
    const missile = document.createElement("div");
    missile.className = "missile";
    missile.style.left = (this.ship.offsetLeft + this.ship.offsetWidth / 2 - 3) + "px";
    missile.style.bottom = (parseFloat(getComputedStyle(this.ship).bottom) + 60) + "px"; // D√©part au dessus du vaisseau
    this.gameArea.appendChild(missile);
    this.missiles.push(missile);
  }

  spawnAnswers() {
    const opts = this.currentQuestion.options;
    const n = opts.length;
    const now = performance.now();

    opts.forEach((opt, index) => {
      const answerEl = document.createElement("div");
      answerEl.className = "falling-answer";
      const lanePercent = ((index + 1) / (n + 1)) * 100;
      answerEl.style.left = lanePercent + "%";
      answerEl.style.top = "0px"; 
      answerEl.textContent = opt;
      answerEl.dataset.isCorrect = (opt === this.currentQuestion.a) ? "true" : "false";
      answerEl.dataset.startTime = now + this.READING_TIME + (Math.random() * 1500); 
      answerEl.dataset.speed = (this.gameArea.offsetHeight) / (this.FALL_DURATION / 16); 
      this.gameArea.appendChild(answerEl);
      this.answers.push(answerEl);
    });
  }

  gameLoop() {
    if (this.controller.getState().isLocked) {
        this.animationFrameId = requestAnimationFrame(() => this.gameLoop());
        return; 
    }
    this.updateState();
    this.animationFrameId = requestAnimationFrame(() => this.gameLoop());
  }

  updateState() {
    const now = performance.now();

    // 1. MOUVEMENT
    const SHIP_SPEED = 8; 
    if (this.isLeftPressed) this.moveShip(-SHIP_SPEED);
    if (this.isRightPressed) this.moveShip(SHIP_SPEED);

    const shipTop = this.ship.offsetTop; 

    // 2. REPONSES
    for (let i = this.answers.length - 1; i >= 0; i--) {
      const ans = this.answers[i];
      const startTime = parseFloat(ans.dataset.startTime);
      
      if (now > startTime) {
        const speed = parseFloat(ans.dataset.speed);
        const currentTop = parseFloat(ans.style.top) || 0;
        const newTop = currentTop + speed; 
        ans.style.top = newTop + "px";

        if (newTop > shipTop && ans.dataset.isCorrect === "true" && !ans.dataset.passed) {
            ans.dataset.passed = "true"; 
            this.handleLevelFail(); 
            return;
        }
        if (newTop > this.gameArea.offsetHeight) {
            ans.remove();
            this.answers.splice(i, 1);
        }
      }
    }

    // 3. MISSILES
    for (let i = this.missiles.length - 1; i >= 0; i--) {
      const m = this.missiles[i];
      let bottom = parseFloat(m.style.bottom);
      bottom += 8; 
      m.style.bottom = bottom + "px";

      const mRect = m.getBoundingClientRect();
      let hit = false;

      for (let j = this.answers.length - 1; j >= 0; j--) {
        const ans = this.answers[j];
        const aRect = ans.getBoundingClientRect();

        if (
          mRect.right > aRect.left &&
          mRect.left < aRect.right &&
          mRect.top < aRect.bottom &&
          mRect.bottom > aRect.top
        ) {
          hit = true;
          this.handleCollision(ans);
          ans.remove();
          this.answers.splice(j, 1);
          break; 
        }
      }

      if (hit || bottom > this.gameArea.offsetHeight) {
        m.remove();
        this.missiles.splice(i, 1);
      }
    }
  }

  handleCollision(answerEl) {
    const isCorrect = answerEl.dataset.isCorrect === "true";
    if (isCorrect) {
        this.resetAnimation(false); 
        this.controller.notifyCorrectAnswer();
    } else {
        this.resetAnimation();
        if(typeof localScores !== 'undefined') {
            localScores[currentIndex] = Math.max(0, localScores[currentIndex] - 1);
            if(typeof updateBars === 'function') updateBars();
        }
        this.controller.notifyWrongAnswer(this.currentQuestion);
    }
  }

  handleLevelFail() {
    this.resetAnimation();
    this.controller.notifyWrongAnswer(null);
  }

  clearObjects() {
    this.answers.forEach(a => a.remove());
    this.missiles.forEach(m => m.remove());
    this.answers = [];
    this.missiles = [];
    this.isLeftPressed = false;
    this.isRightPressed = false;
  }

  startAnimation() {
    if (!this.animationFrameId) this.gameLoop();
  }

  resetAnimation(fullClear = true) {
    if (fullClear) {
        this.clearObjects();
    }
  }
}

window.StarshipGame = StarshipGame;
</script>