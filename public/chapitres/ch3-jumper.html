<template id="template-jumper-game">
  <style>
    /* --- UI QUESTION --- */
    .jumper-question-zone {
      text-align: center;
      margin-bottom: 10px;
      color: #111827;
    }
    .q-text { font-size: 1.2em; font-weight: 800; margin-bottom: 8px; }
    
    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }
    .opt-badge {
      padding: 6px 10px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 13px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      white-space: normal; 
    }
    .opt-red { background-color: #ef4444; border: 2px solid #b91c1c; }
    .opt-green { background-color: #22c55e; border: 2px solid #15803d; }
    .opt-orange { background-color: #f97316; border: 2px solid #c2410c; }
    .opt-blue { background-color: #3b82f6; border: 2px solid #1d4ed8; }

    /* --- JEU --- */
    #jumper-area {
      position: relative;
      height: clamp(250px, 40vh, 400px);
      background: linear-gradient(#bae6fd, #f0f9ff); 
      border: 4px solid #334155;
      border-radius: 12px;
      overflow: hidden;
      touch-action: none; 
    }

    #player {
      position: absolute;
      width: 40px;
      height: 40px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 10;
      transition: transform 0.1s; /* Pour le retournement gauche/droite */
    }

    .platform {
      position: absolute;
      height: 40px;
      background-color: #475569; 
      border-top: 4px solid #334155;
      border-radius: 4px;
    }

    #plat-choice {
      display: flex;
      overflow: hidden;
      border: none;
      background: transparent;
    }
    .plat-segment {
      flex: 1;
      height: 100%;
    }
    .seg-red { background: #ef4444; }
    .seg-green { background: #22c55e; }
    .seg-orange { background: #f97316; }
    .seg-blue { background: #3b82f6; }

    /* Porte d'arriv√©e (Cach√©e par d√©faut) */
    #goal-door {
      position: absolute;
      width: 40px;
      height: 60px;
      background: #8b5cf6;
      border: 3px solid #5b21b6;
      border-radius: 8px 8px 0 0;
      bottom: 40px; 
      right: 20px;
      display: none; /* Invisible au d√©but */
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }
    
    /* Classe pour faire appara√Ætre la porte */
    .door-visible {
      display: flex !important;
      opacity: 1 !important;
    }

    /* --- CONTROLES --- */
    #jumper-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding: 0 10px;
      user-select: none;
    }
    .ctrl-btn {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: #f1f5f9;
      border: 2px solid #cbd5e1;
      font-size: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 0 #cbd5e1;
      transition: transform 0.1s;
    }
    .ctrl-btn:active { transform: translateY(4px); box-shadow: none; }
    
    .btn-jump { width: 80px; background: #dcfce7; border-color: #86efac; color: #166534; box-shadow: 0 4px 0 #86efac; }
    .btn-jump:active { transform: translateY(4px); box-shadow: none; }
  </style>

  <div class="jumper-question-zone">
    <div id="q-text" class="q-text">Question...</div>
    <div id="options-grid" class="options-grid"></div>
  </div>

  <div id="jumper-area">
    <div id="player"></div>
    
    <div id="plat-start" class="platform" style="left: 0; bottom: 40px; width: 20%;"></div>
    
    <div id="plat-choice" class="platform" style="left: 30%; bottom: 60px; width: 50%;">
      <div class="plat-segment seg-red"></div>
      <div class="plat-segment seg-green"></div>
      <div class="plat-segment seg-orange"></div>
      <div class="plat-segment seg-blue"></div>
    </div>

    <div id="plat-end" class="platform" style="right: 0; bottom: 40px; width: 15%;"></div>
    <div id="goal-door" style="right: 10px; bottom: 80px;">‚òÖ</div>
  </div>

  <div id="jumper-controls">
    <div style="display:flex; gap:15px;">
      <div id="btn-left" class="ctrl-btn">‚¨ÖÔ∏è</div>
      <div id="btn-right" class="ctrl-btn">‚û°Ô∏è</div>
    </div>
    <div id="btn-jump" class="ctrl-btn btn-jump">üöÄ</div>
  </div>
</template>

<script>
class JumperGame {
  constructor(container, controller) {
    this.container = container;
    this.controller = controller;
    
    this.area = container.querySelector("#jumper-area");
    this.player = container.querySelector("#player");
    
    this.platStart = container.querySelector("#plat-start");
    this.platChoice = container.querySelector("#plat-choice");
    this.platEnd = container.querySelector("#plat-end");
    this.goalDoor = container.querySelector("#goal-door");
    
    this.qText = container.querySelector("#q-text");
    this.optGrid = container.querySelector("#options-grid");

    this.btnLeft = container.querySelector("#btn-left");
    this.btnRight = container.querySelector("#btn-right");
    this.btnJump = container.querySelector("#btn-jump");

    // Physique Initiale
    this.x = 20; 
    this.y = 80; 
    this.vx = 0; 
    this.vy = 0;
    
    // --- REGLAGES PHYSIQUE VOL INFINI ---
    this.GRAVITY = 0.6;       
    this.THRUST = 1.0;        // Pouss√©e douce
    this.MAX_V_SPEED = 4;     // Plafond vitesse plus bas (monte moins vite)
    
    this.MOVE_SPEED = 0.55;    
    this.FRICTION = 0.85;     

    // Inputs
    this.keys = { left: false, right: false, jump: false };
    this.currentQ = null;
    this.correctColorIndex = -1; 
    this.animId = null;
    this.onGround = true;

    this.colors = [
      { name: "red", hex: "#ef4444" },
      { name: "green", hex: "#22c55e" },
      { name: "orange", hex: "#f97316" },
      { name: "blue", hex: "#3b82f6" }
    ];

    this.bindControls();
  }

  loadQuestion(q) {
    this.currentQ = q;
    this.qText.textContent = q.q;
    
    const shuffledOptions = [...q.options].sort(() => 0.5 - Math.random());
    this.optGrid.innerHTML = "";
    this.correctColorIndex = -1;

    shuffledOptions.forEach((opt, idx) => {
      if (idx > 3) return; 
      const colorObj = this.colors[idx];
      const el = document.createElement("div");
      el.className = `opt-badge opt-${colorObj.name}`;
      el.textContent = opt;
      this.optGrid.appendChild(el);

      if (opt === q.a) this.correctColorIndex = idx;
    });

    this.resetPosition();
    if (!this.animId) this.loop();
  }

  resetPosition() {
    this.x = 20;
    this.y = 80; 
    this.vx = 0;
    this.vy = 0;
    this.onGround = true;
    
    // Reset Porte
    this.goalDoor.classList.remove('door-visible');
    
    this.player.style.left = this.x + "px";
    this.player.style.bottom = this.y + "px";
    this.player.style.backgroundImage = "url('/images/jumper.png')";
  }

  bindControls() {
    // Clavier
    document.addEventListener("keydown", (e) => {
      if(this.controller.getState().isLocked) return;
      if(e.key === "ArrowLeft") this.keys.left = true;
      if(e.key === "ArrowRight") this.keys.right = true;
      if(e.code === "Space" || e.key === "ArrowUp") this.keys.jump = true;
    });
    document.addEventListener("keyup", (e) => {
      if(e.key === "ArrowLeft") this.keys.left = false;
      if(e.key === "ArrowRight") this.keys.right = false;
      if(e.code === "Space" || e.key === "ArrowUp") this.keys.jump = false;
    });

    // Tactile
    const bindBtn = (btn, key) => {
      const start = (e) => { e.preventDefault(); this.keys[key] = true; };
      const end = (e) => { e.preventDefault(); this.keys[key] = false; };
      btn.addEventListener("mousedown", start);
      btn.addEventListener("touchstart", start);
      btn.addEventListener("mouseup", end);
      btn.addEventListener("touchend", end);
      btn.addEventListener("mouseleave", end);
    };
    bindBtn(this.btnLeft, "left");
    bindBtn(this.btnRight, "right");
    bindBtn(this.btnJump, "jump");
  }

  loop() {
    if (this.controller.getState().isLocked) {
      this.animId = requestAnimationFrame(() => this.loop());
      return;
    }
    this.update();
    this.draw();
    this.animId = requestAnimationFrame(() => this.loop());
  }

  update() {
    // 1. Horizontal
    if (this.keys.left) this.vx -= this.MOVE_SPEED;
    if (this.keys.right) this.vx += this.MOVE_SPEED;
    
    if (!this.keys.left && !this.keys.right) {
        // Arr√™t plus net au sol
        if (this.onGround) this.vx *= 0.5; 
        else this.vx *= this.FRICTION;
        
        if (Math.abs(this.vx) < 0.1) this.vx = 0;
    }

    // Plafond vitesse lat√©rale
    if (this.vx > 3) this.vx = 3;
    if (this.vx < -3) this.vx = -3;

    this.x += this.vx;

    if (this.x < 0) { this.x = 0; this.vx = 0; }
    if (this.x > this.area.offsetWidth - 40) { this.x = this.area.offsetWidth - 40; this.vx = 0; }

    // 2. Vertical (VOL INFINI)
    this.vy -= this.GRAVITY;

    // Si on appuie, on vole (pas de limite de fuel)
    if (this.keys.jump) {
      this.vy += this.THRUST; 
    }
    
    if (this.vy > this.MAX_V_SPEED) this.vy = this.MAX_V_SPEED;

    this.y += this.vy;
    
    const maxY = this.area.offsetHeight - 40;
    if (this.y > maxY) { this.y = maxY; this.vy = -0.5; }

    // 3. Collisions
    this.onGround = false; 
    const platforms = [
      { el: this.platStart, type: 'safe' },
      { el: this.platChoice, type: 'choice' },
      { el: this.platEnd, type: 'safe' }
    ];

    if (this.vy <= 0) { 
      platforms.forEach(p => {
        const rect = p.el.getBoundingClientRect();
        const areaRect = this.area.getBoundingClientRect();
        
        const platLeft = rect.left - areaRect.left;
        const platRight = rect.right - areaRect.left;
        const platTop = areaRect.bottom - rect.top; 

        if (this.x + 30 > platLeft && this.x + 10 < platRight) {
          if (this.y <= platTop && this.y + 20 >= platTop) {
            
            // TEST COULEUR
            if (p.type === 'choice') {
              const width = platRight - platLeft;
              const segmentWidth = width / 4;
              const playerCenter = (this.x + 20) - platLeft;
              const segmentIndex = Math.floor(playerCenter / segmentWidth);

              if (segmentIndex !== this.correctColorIndex) {
                return; // Passe √† travers
              }
              
              // SI ON EST ICI = BONNE COULEUR !
              // On fait appara√Ætre la porte
              this.goalDoor.classList.add('door-visible');
            }

            // Atterrissage
            this.y = platTop;
            this.vy = 0;
            this.onGround = true; 
          }
        }
      });
    }

    // 4. Mort
    if (this.y < -50) {
      if(typeof localScores !== 'undefined') {
          localScores[currentIndex] = Math.max(0, localScores[currentIndex] - 1);
          if(typeof updateBars === 'function') updateBars();
      }
      this.controller.notifyWrongAnswer(this.currentQ);
      this.resetPosition();
    }

    // 5. Victoire (Porte) - SEULEMENT SI VISIBLE
    if (this.goalDoor.classList.contains('door-visible')) {
        const doorRect = this.goalDoor.getBoundingClientRect();
        const areaRect = this.area.getBoundingClientRect();
        const doorLeft = doorRect.left - areaRect.left;
        const doorRight = doorRect.right - areaRect.left;
        const doorBottom = areaRect.bottom - doorRect.bottom;

        if (this.x + 30 > doorLeft && this.x + 10 < doorRight && this.y <= doorBottom + 60 && this.y >= doorBottom) {
          this.controller.notifyCorrectAnswer();
          this.resetPosition();
        }
    }
  }

  draw() {
    this.player.style.left = this.x + "px";
    this.player.style.bottom = this.y + "px";
    
    // Changement de Costume
    if (this.onGround) {
        this.player.style.backgroundImage = "url('/images/jumper.png')";
    } else {
        this.player.style.backgroundImage = "url('/images/jetpack.png')";
    }

    // Orientation
    if (this.vx > 0.1) this.player.style.transform = "scaleX(1)";
    else if (this.vx < -0.1) this.player.style.transform = "scaleX(-1)";
  }

  startAnimation() { if (!this.animId) this.loop(); }
  resetAnimation() { this.resetPosition(); }
}

window.JumperGame = JumperGame;
</script>