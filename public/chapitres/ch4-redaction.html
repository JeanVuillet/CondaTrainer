<template id="template-redaction-game">
  <style>
    .redac-container {
      display: flex; flex-direction: column; align-items: center; gap: 15px;
      padding: 10px; text-align: center; height: 100%; overflow-y: auto;
    }
    
    .redac-context-box {
      background: #fff7ed; border-left: 4px solid #f97316; width: 100%;
      padding: 10px; text-align: left; font-size: 0.95em; color: #431407;
      display: none; border-radius: 4px; margin-bottom: 5px;
    }
    .context-label { font-weight: 800; text-transform: uppercase; font-size: 0.8em; color: #ea580c; display: block; margin-bottom: 4px; }

    .redac-question {
      font-size: 1.1em; font-weight: 700; color: #1e293b;
      background: #e0f2fe; padding: 15px; border-radius: 12px; border: 2px solid #3b82f6;
      width: 100%;
    }
    .redac-input {
      width: 100%; height: 150px; padding: 15px; font-size: 16px;
      border: 2px solid #cbd5e1; border-radius: 10px; font-family: inherit; resize: vertical;
    }
    .redac-input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
    
    .redac-btn {
      background: #2563eb; color: white; border: none; padding: 12px 30px;
      font-size: 16px; font-weight: 700; border-radius: 10px; cursor: pointer;
      transition: transform 0.1s;
    }
    .redac-btn:disabled { background: #94a3b8; cursor: not-allowed; }
    
    .redac-continue-btn {
      background: #16a34a; color: white; border: none; padding: 15px 40px;
      font-size: 18px; font-weight: 800; border-radius: 10px; cursor: pointer;
      display: none; margin-top: 10px; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.3);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* ZONE RESULTAT (NOTE) */
    .result-header {
      display: none; width: 100%; background: #f8fafc; border-radius: 10px;
      padding: 15px; margin-bottom: 10px; border: 2px solid #e2e8f0;
    }
    .grade-badge {
      display: inline-block; padding: 5px 15px; border-radius: 20px;
      font-size: 1.5em; font-weight: 900; color: white; background: #3b82f6;
      margin-bottom: 5px;
    }
    .short-comment { font-size: 1.1em; font-weight: 700; color: #334155; display: block; }

    /* ZONES D'ANALYSE */
    .analysis-container { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-top: 10px; display: none; }
    .analysis-box { padding: 10px; border-radius: 8px; text-align: left; font-size: 0.95em; line-height: 1.4; }
    .box-good { background: #dcfce7; border: 1px solid #86efac; color: #166534; }
    .box-missing { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
    .box-title { font-weight: 800; display: block; margin-bottom: 4px; text-transform: uppercase; font-size: 0.85em; }

    .redac-loading { display: none; color: #2563eb; font-weight: 600; margin-top: 10px; }
  </style>

  <div class="redac-container">
    <div id="redac-context" class="redac-context-box">
      <span class="context-label">Contexte</span>
      <span id="redac-context-text"></span>
    </div>

    <div id="redac-q" class="redac-question">Question...</div>
    
    <textarea id="redac-answer" class="redac-input" placeholder="R√©dige ta r√©ponse ici..."></textarea>
    
    <div id="redac-loading" class="redac-loading">üß† Correction en cours...</div>
    
    <!-- RESULTAT (Note + Phrase) -->
    <div id="result-header" class="result-header">
        <span id="grade-badge" class="grade-badge"></span>
        <span id="short-comment" class="short-comment"></span>
    </div>

    <button id="redac-submit" class="redac-btn">Envoyer √† l'IA ü§ñ</button>
    <button id="redac-continue" class="redac-continue-btn">Continuer ‚ûî</button>
    
    <!-- ANALYSE DETAILS -->
    <div id="analysis-area" class="analysis-container">
        <div id="box-good" class="analysis-box box-good">
            <span class="box-title">‚úÖ Points forts :</span>
            <span id="text-good"></span>
        </div>
        <div id="box-missing" class="analysis-box box-missing">
            <span class="box-title">‚ö†Ô∏è √Ä compl√©ter / corriger :</span>
            <span id="text-missing"></span>
        </div>
        
        <!-- Orthographe -->
        <div id="box-spelling" style="display:none; font-size:0.9em; border-top:1px solid #ccc; padding-top:10px; color:#b91c1c; text-align:left;">
            <b>Orthographe :</b> <ul id="list-spelling" style="margin:5px 0; padding-left:20px;"></ul>
        </div>
    </div>
  </div>
</template>

<script>
class RedactionGame {
  constructor(container, controller) {
    this.container = container;
    this.controller = controller;
    
    this.qEl = container.querySelector("#redac-q");
    this.contextBox = container.querySelector("#redac-context");
    this.contextText = container.querySelector("#redac-context-text");
    this.contextLabel = container.querySelector(".context-label");
    this.input = container.querySelector("#redac-answer");
    this.submitBtn = container.querySelector("#redac-submit");
    this.continueBtn = container.querySelector("#redac-continue");
    this.loadingEl = container.querySelector("#redac-loading");
    
    // Nouveaux √©l√©ments
    this.resultHeader = container.querySelector("#result-header");
    this.gradeBadge = container.querySelector("#grade-badge");
    this.shortComment = container.querySelector("#short-comment");
    
    this.analysisArea = container.querySelector("#analysis-area");
    this.boxGood = container.querySelector("#box-good");
    this.textGood = container.querySelector("#text-good");
    this.boxMissing = container.querySelector("#box-missing");
    this.textMissing = container.querySelector("#text-missing");
    this.boxSpelling = container.querySelector("#box-spelling");
    this.listSpelling = container.querySelector("#list-spelling");
    
    this.currentQuestion = null;
    this.isProcessing = false;

    this.submitBtn.addEventListener("click", () => this.submit());
    this.continueBtn.addEventListener("click", () => { this.controller.notifyCorrectAnswer(); });
  }

  loadQuestion(q) {
    this.currentQuestion = q;
    this.qEl.innerHTML = q.q.replace(/\n/g, "<br>");
    
    if (q.context) {
        this.contextBox.style.display = "block";
        this.contextText.innerHTML = q.context.replace(/\n/g, "<br>");
        if(q.mode === "argument") this.contextLabel.textContent = "Partie √† soutenir :";
        else if(q.mode === "exemple") this.contextLabel.textContent = "Argument √† illustrer :";
        else if(q.mode === "conclusion") this.contextLabel.textContent = "Introduction de d√©part :";
        else this.contextLabel.textContent = "Contexte :";
    } else { this.contextBox.style.display = "none"; }

    if (q.mode === "intro") this.input.placeholder = "D√©finition, Bornes, Probl√©matique, Plan...";
    else if (q.mode === "argument") this.input.placeholder = "D'une part... D'autre part...";
    else this.input.placeholder = "R√©dige ici...";

    this.input.value = "";
    this.input.disabled = false;
    this.submitBtn.style.display = "inline-block"; 
    this.submitBtn.disabled = false;
    this.submitBtn.textContent = "Envoyer √† l'IA ü§ñ";
    this.submitBtn.style.backgroundColor = "#2563eb";
    this.continueBtn.style.display = "none";
    this.analysisArea.style.display = "none";
    this.resultHeader.style.display = "none";
    this.isProcessing = false;
    
    setTimeout(() => { if(!window.isGlobalPaused) this.input.focus(); }, 100);
  }

  async submit() {
    if (this.controller.getState().isLocked || this.isProcessing) return;
    const text = this.input.value.trim();
    if (!text) return alert("√âcris quelque chose !");

    this.isProcessing = true;
    this.input.disabled = true;
    this.submitBtn.disabled = true;
    this.submitBtn.style.display = "none";
    this.loadingEl.style.display = "block";
    this.analysisArea.style.display = "none";
    this.resultHeader.style.display = "none";

    const player = JSON.parse(localStorage.getItem('player') || '{}');

    try {
        const res = await fetch('/api/verify-answer-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question: this.currentQuestion.q,
                userAnswer: text,
                expectedAnswer: this.currentQuestion.a,
                playerId: player.id || player._id,
                redactionMode: this.currentQuestion.mode,
                context: this.currentQuestion.context
            })
        });
        const data = await res.json();
        const status = data.status || "incorrect";
        this.loadingEl.style.display = "none";

        const formatList = (content) => {
            if (!content) return null;
            if (Array.isArray(content)) return content.map(item => `‚Ä¢ ${item}`).join('<br>');
            return content.replace(/\n/g, "<br>");
        };

        // Affichage Note + Commentaire court
        this.resultHeader.style.display = "block";
        this.gradeBadge.textContent = data.grade || "-/20";
        this.shortComment.textContent = data.short_comment || (status === "correct" ? "Excellent !" : "√Ä retravailler.");
        
        // Couleur Note
        if(status === "correct") this.gradeBadge.style.backgroundColor = "#16a34a";
        else if(status === "close") this.gradeBadge.style.backgroundColor = "#ea580c";
        else this.gradeBadge.style.backgroundColor = "#ef4444";

        // Affichage D√©tails
        this.analysisArea.style.display = "flex";
        
        const goodContent = formatList(data.good_points);
        if (goodContent) { this.textGood.innerHTML = goodContent; this.boxGood.style.display = "block"; } else { this.boxGood.style.display = "none"; }

        const missingContent = formatList(data.missing_points);
        if (missingContent) { this.textMissing.innerHTML = missingContent; this.boxMissing.style.display = "block"; } else { this.boxMissing.style.display = "none"; }

        // Orthographe
        if (data.corrections && data.corrections.length > 0) {
             let spellingHTML = ""; data.corrections.forEach(c => spellingHTML += `<li><s>${c.wrong}</s> ‚ûî <b>${c.correct}</b></li>`);
             this.listSpelling.innerHTML = spellingHTML; this.boxSpelling.style.display = "block";
        } else { this.boxSpelling.style.display = "none"; }

        if (status === "correct") {
            this.continueBtn.style.display = "inline-block"; this.input.disabled = true;
        } else {
            this.isProcessing = false;
            this.input.disabled = false;
            this.submitBtn.style.display = "inline-block";
            this.submitBtn.disabled = false;
            this.submitBtn.textContent = "Am√©liorer et Renvoyer üìù";
            this.submitBtn.style.backgroundColor = "#ea580c";
            if (status === "incorrect") { this.controller.notifyWrongAnswer(null); }
        }
    } catch (e) {
        this.loadingEl.textContent = "Erreur technique.";
        this.isProcessing = false;
        this.input.disabled = false;
        this.submitBtn.style.display = "inline-block";
        this.submitBtn.disabled = false;
    }
  }

  startAnimation() {} resetAnimation() {}
}
window.RedactionGame = RedactionGame;
</script>